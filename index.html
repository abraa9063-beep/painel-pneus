<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Transportes Canarinho - Estoque de Pneus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --panel-light: #1f2937;
      --accent: #38bdf8;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --radius: 14px;
    }
    * {
      box-sizing: border-box;
      font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
    }
    body {
      margin: 0;
      background: radial-gradient(circle at center, rgba(2, 6, 23, 0) 0%, rgba(2, 6, 23, 0.65) 60%, #020617 100%),
        url("logo-canarinhos.png") no-repeat center center;
      background-size: 900px auto;
      color: var(--text);
      min-height: 100vh;
    }
    header {
      padding: 16px 24px 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .logo-icon {
      width: 40px;
      height: 40px;
      object-fit: contain;
    }
    header h1 {
      margin: 0;
      font-size: 1.05rem;
    }
    .small {
      font-size: .7rem;
      color: var(--muted);
    }
    .tag {
      background: rgba(56, 189, 248, 0.12);
      border: 1px solid rgba(56, 189, 248, 0.4);
      padding: 3px 12px;
      border-radius: 999px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-left: auto;
      margin-right: 24px;
    }
    .header-center {
      width: 100%;
      border-top: 1px solid rgba(148, 163, 184, 0.12);
      margin-top: 10px;
      padding: 6px 24px 10px;
      font-size: .75rem;
      letter-spacing: .04em;
    }
    main {
      max-width: 1250px;
      margin: 0 auto;
      padding: 12px 24px 50px;
    }
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .tab-btn {
      background: rgba(15, 23, 42, 0.2);
      border: none;
      color: var(--text);
      padding: 7px 16px;
      border-radius: 999px;
      cursor: pointer;
      font-size: .78rem;
    }
    .tab-btn.active {
      background: rgba(56, 189, 248, 0.12);
      border: 1px solid rgba(56, 189, 248, 0.3);
    }
    .toolbar {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .input {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 999px;
      padding: 8px 14px 8px 32px;
      color: var(--text);
    }
    .input-wrapper { position: relative; }
    .input-icon {
      position: absolute;
      left: 10px;
      top: 7px;
      font-size: .8rem;
      color: var(--muted);
    }
    select.input {
      padding-left: 12px;
    }
    .btn {
      background: #0ea5e9;
      border: none;
      color: #020617;
      border-radius: 999px;
      padding: 8px 16px;
      font-weight: 600;
      font-size: .78rem;
      cursor: pointer;
    }
    .card {
      background: rgba(2, 6, 23, 0.55);
      border: 1px solid rgba(148, 163, 184, 0.06);
      border-radius: var(--radius);
      overflow: hidden;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }
    thead {
      background: rgba(15, 23, 42, 0.42);
    }
    th, td {
      padding: 9px 12px;
      font-size: .78rem;
      text-align: left;
    }
    tbody tr {
      border-bottom: 1px solid rgba(148, 163, 184, 0.05);
    }
    tbody tr:hover {
      background: rgba(15, 23, 42, 0.25);
    }
    .list-wrapper { overflow-x: auto; }
    .badge {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.15);
      border-radius: 999px;
      padding: 2px 10px;
      font-size: .7rem;
    }
    .actions { display: flex; gap: 6px; }
    .btn-xs {
      background: rgba(15, 23, 42, 0.4);
      border: 1px solid rgba(148, 163, 184, 0.12);
      color: var(--text);
      padding: 3px 9px;
      border-radius: 999px;
      font-size: .7rem;
      cursor: pointer;
    }
    .btn-danger {
      background: rgba(244, 63, 94, 0.12);
      border: 1px solid rgba(244, 63, 94, 0.3);
      color: #ffe4e6;
    }
    .hidden { display:none; }

    /* modalzinho */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal {
      background: #0f172a;
      border: 1px solid rgba(148,163,184,0.22);
      border-radius: 15px;
      padding: 16px;
      width: 360px;
      max-height: 90vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .modal input, .modal select {
      background: rgba(15,23,42,.3);
      border: 1px solid rgba(148,163,184,.15);
      border-radius: 8px;
      padding: 5px 7px;
      color: var(--text);
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 8px;
    }
    /* bloco google */
    #sheetBlock table td {
      font-size: .7rem;
    }
    @media (max-width: 720px) {
      header { flex-direction: column; align-items: flex-start; }
      .tag { margin-left: 0; }
      .toolbar { flex-direction: column; }
      .input, select.input { width: 100%; }
    }
  </style>
</head>
<body>
  <header>
    <img src="logo-canarinhos2.png" class="logo-icon" alt="Transportes Canarinho">
    <div>
      <h1>Transportes Canarinho</h1>
      <div class="small">Buscando entregar o melhor com qualidade.</div>
    </div>
    <span class="tag" id="saveStatus">autosave ativo</span>
  </header>
  <div class="header-center">ESTOQUE DE PNEUS</div>

  <main>
    <div class="tabs">
      <button class="tab-btn active" data-tab="estoque">Estoque</button>
      <button class="tab-btn" data-tab="saidas">Sa√≠das</button>
      <button class="tab-btn" data-tab="recapagem">Recapagem</button>
      <button class="tab-btn" data-tab="descarte">Descarte</button>
    </div>

    <!-- ESTOQUE -->
    <div id="tab-estoque">
      <div class="toolbar">
        <div class="input-wrapper">
          <span class="input-icon">üîç</span>
          <input id="searchInput" class="input" placeholder="Buscar por FOGO ou nome..." />
        </div>
        <select id="categoryFilter" class="input" style="width:auto;">
          <option value="">Todas as categorias</option>
        </select>
        <button id="addItemBtn" class="btn">+ Novo pneu</button>
      </div>

      <div class="card">
        <div class="list-wrapper">
          <table>
            <thead>
              <tr>
                <th>FOGO</th>
                <th>Nome</th>
                <th>Foto</th>
                <th>Categoria</th>
                <th>Marca</th>
                <th>Modelo</th>
                <th>Tamanho</th>
                <th>Qtd.</th>
                <th>Reposi√ß√£o</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- SA√çDAS -->
    <div id="tab-saidas" class="hidden">
      <div class="card">
        <div class="list-wrapper">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>FOGO / Nome</th>
                <th>Qtd.</th>
                <th>Placa</th>
                <th>Marca</th>
                <th>Modelo</th>
                <th>Tam.</th>
                <th>Pre√ßo</th>
                <th>Obs</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="movementsBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- RECAPAGEM -->
    <div id="tab-recapagem" class="hidden">
      <div class="card">
        <div class="list-wrapper">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>FOGO</th>
                <th>Marca</th>
                <th>Modelo</th>
                <th>Tam.</th>
                <th>Borracha</th>
                <th>Recapadora</th>
                <th>Qtd.</th>
                <th>Status</th>
                <th>Obs</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="recapTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- DESCARTE -->
    <div id="tab-descarte" class="hidden">
      <div class="card">
        <div class="list-wrapper">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>FOGO</th>
                <th>Marca</th>
                <th>Modelo</th>
                <th>Tam.</th>
                <th>Motivo</th>
                <th>Obs</th>
              </tr>
            </thead>
            <tbody id="descTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- BLOCO GOOGLE SHEETS -->
    <div id="sheetBlock" class="card" style="margin-top:18px;">
      <div style="padding:10px 14px 0;">
        <strong>Registros do Google Sheets</strong>
        <div class="small" id="sheetStatus">Carregando dados...</div>
      </div>
      <div class="list-wrapper">
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Placa</th>
              <th>N¬∫ do pneu</th>
              <th>Quantidade</th>
              <th>Marca</th>
              <th>Modelo</th>
            </tr>
          </thead>
          <tbody id="sheetBody">
            <tr><td colspan="6">Carregando...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- MODAIS (s√≥ um b√°sico) -->
  <div class="modal-backdrop" id="editModal">
    <div class="modal">
      <h2 id="editTitle">Novo pneu</h2>
      <label>FOGO</label>
      <input id="editId" />
      <label>Nome</label>
      <input id="editName" />
      <label>Categoria</label>
      <input id="editCategory" value="Pneu" />
      <label>Marca</label>
      <input id="editMarca" value="Michelin" />
      <label>Modelo</label>
      <input id="editModelo" value="X Multi Z" />
      <label>Tamanho</label>
      <input id="editTamanho" value="295/80" />
      <label>Quantidade</label>
      <input id="editQty" type="number" value="0" />
      <label>Reposi√ß√£o</label>
      <input id="editReorder" type="number" value="0" />
      <div class="modal-actions">
        <button class="btn-xs" onclick="closeEditModal()">Cancelar</button>
        <button class="btn" onclick="saveItem()">Salvar</button>
      </div>
    </div>
  </div>

  <script>
    /* ====== 1) SEU ENDPOINT DO APPS SCRIPT ====== */
    const SHEETS_ENDPOINT = "https://script.google.com/macros/s/AKfycbwVgzTSpsua4U8VqCBCLjsKAekpKqYR9MosYkkGv_0WXtd-RRfJWct5G1jb5g8TI_sf9g/exec";

    /* ====== 2) DADOS LOCAIS ====== */
    const STORAGE_KEY_ITEMS = "tc_pneus_items_v1";
    const STORAGE_KEY_MOVES = "tc_pneus_moves_v1";
    const STORAGE_KEY_RECAP = "tc_pneus_recap_v1";
    const STORAGE_KEY_DESC = "tc_pneus_desc_v1";

    let items = loadLocal(STORAGE_KEY_ITEMS, [
      { id: "F-001", name: "Pneu 295/80", category: "Pneu", qty: 9, reorderPoint: 3, marca: "Michelin", modelo: "X Multi Z", tamanho: "295/80", photo: "" },
      { id: "F-002", name: "Pneu 295/80", category: "Pneu", qty: 4, reorderPoint: 2, marca: "Pirelli", modelo: "FG-01 MISTO", tamanho: "295/80", photo: "" },
      { id: "21414", name: "dwadwadwad", category: "Pneu", qty: 10, reorderPoint: 0, marca: "Michelin", modelo: "X Multi Z", tamanho: "295/80", photo: "" }
    ]);
    let movements = loadLocal(STORAGE_KEY_MOVES, []);
    let recapagens = loadLocal(STORAGE_KEY_RECAP, []);
    let descartes = loadLocal(STORAGE_KEY_DESC, []);

    function loadLocal(key, fallback) {
      const raw = localStorage.getItem(key);
      if (!raw) return fallback;
      try { return JSON.parse(raw); } catch(e) { return fallback; }
    }
    function saveAll() {
      localStorage.setItem(STORAGE_KEY_ITEMS, JSON.stringify(items));
      localStorage.setItem(STORAGE_KEY_MOVES, JSON.stringify(movements));
      localStorage.setItem(STORAGE_KEY_RECAP, JSON.stringify(recapagens));
      localStorage.setItem(STORAGE_KEY_DESC, JSON.stringify(descartes));
      const ss = document.getElementById("saveStatus");
      if (ss) {
        ss.textContent = "salvo ‚úî";
        setTimeout(()=> ss.textContent = "autosave ativo", 1400);
      }
    }

    /* ====== 3) RENDER ESTOQUE ====== */
    const tableBody = document.getElementById("tableBody");
    const searchInput = document.getElementById("searchInput");
    const categoryFilter = document.getElementById("categoryFilter");

    function renderItems() {
      const term = (searchInput.value || "").toLowerCase();
      const cat = categoryFilter.value;
      tableBody.innerHTML = "";
      items
        .filter(it => {
          const okT = it.id.toLowerCase().includes(term) || it.name.toLowerCase().includes(term);
          const okC = cat ? it.category === cat : true;
          return okT && okC;
        })
        .forEach(it => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${it.id}</td>
            <td>${it.name}</td>
            <td>${it.photo ? "<img src='"+it.photo+"' style='width:44px;border-radius:7px;'>" : "sem foto"}</td>
            <td><span class="badge">${it.category||"-"}</span></td>
            <td>${it.marca||"-"}</td>
            <td>${it.modelo||"-"}</td>
            <td>${it.tamanho||"-"}</td>
            <td>${it.qty}</td>
            <td>${it.reorderPoint}</td>
            <td>
              <div class="actions">
                <button class="btn-xs" onclick="openEditModal('${it.id}')">Editar</button>
                <button class="btn-xs btn-danger" onclick="deleteItem('${it.id}')">Excluir</button>
              </div>
            </td>
          `;
          tableBody.appendChild(tr);
        });
    }
    renderItems();

    searchInput.addEventListener("input", renderItems);
    categoryFilter.addEventListener("change", renderItems);

    /* ====== 4) MODAL EDIT ====== */
    const editModal = document.getElementById("editModal");
    document.getElementById("addItemBtn").addEventListener("click", () => openEditModal(null));

    function openEditModal(id) {
      editModal.style.display = "flex";
      const title = document.getElementById("editTitle");
      if (id) {
        const it = items.find(i => i.id === id);
        title.textContent = "Editar pneu";
        document.getElementById("editId").value = it.id;
        document.getElementById("editName").value = it.name;
        document.getElementById("editCategory").value = it.category;
        document.getElementById("editMarca").value = it.marca || "";
        document.getElementById("editModelo").value = it.modelo || "";
        document.getElementById("editTamanho").value = it.tamanho || "";
        document.getElementById("editQty").value = it.qty;
        document.getElementById("editReorder").value = it.reorderPoint;
      } else {
        title.textContent = "Novo pneu";
        document.getElementById("editId").value = "";
        document.getElementById("editName").value = "";
        document.getElementById("editCategory").value = "Pneu";
        document.getElementById("editMarca").value = "Michelin";
        document.getElementById("editModelo").value = "X Multi Z";
        document.getElementById("editTamanho").value = "295/80";
        document.getElementById("editQty").value = 0;
        document.getElementById("editReorder").value = 0;
      }
    }
    function closeEditModal() {
      editModal.style.display = "none";
    }
    function saveItem() {
      const id = document.getElementById("editId").value.trim();
      if (!id) { alert("FOGO obrigat√≥rio"); return; }
      const name = document.getElementById("editName").value.trim() || "Pneu";
      const cat  = document.getElementById("editCategory").value.trim() || "Pneu";
      const marca= document.getElementById("editMarca").value.trim();
      const modelo= document.getElementById("editModelo").value.trim();
      const tam  = document.getElementById("editTamanho").value.trim();
      const qty  = parseInt(document.getElementById("editQty").value, 10) || 0;
      const rep  = parseInt(document.getElementById("editReorder").value, 10) || 0;

      const existing = items.find(i => i.id === id);
      if (existing) {
        existing.name = name;
        existing.category = cat;
        existing.marca = marca;
        existing.modelo = modelo;
        existing.tamanho = tam;
        existing.qty = qty;
        existing.reorderPoint = rep;
      } else {
        items.push({ id, name, category: cat, marca, modelo, tamanho: tam, qty, reorderPoint: rep, photo: "" });
      }
      closeEditModal();
      renderItems();
      saveAll();

      // opcional: mandar pro sheets
      sendToSheet({
        tipo: "salvar_item",
        data: new Date().toLocaleString("pt-BR"),
        placa: "",
        numero: id,
        quantidade: qty,
        marca: marca,
        modelo: modelo
      });
    }
    function deleteItem(id) {
      if (!confirm("Excluir este pneu?")) return;
      items = items.filter(i => i.id !== id);
      renderItems();
      saveAll();
    }

    /* ====== 5) SA√çDAS (render simples) ====== */
    const movementsBody = document.getElementById("movementsBody");
    function renderMovements() {
      movementsBody.innerHTML = "";
      movements.forEach(m => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${m.date}</td>
          <td>${m.itemId} ‚Äì ${m.itemName||""}</td>
          <td>${m.qty}</td>
          <td>${m.plate||"-"}</td>
          <td>${m.marca||"-"}</td>
          <td>${m.modelo||"-"}</td>
          <td>${m.tamanho||"-"}</td>
          <td>${m.price ? "R$ "+m.price.toFixed(2):"-"}</td>
          <td>${m.obs||"-"}</td>
          <td><button class="btn-xs btn-danger" onclick="removeMovement('${m.localId}')">Remover</button></td>
        `;
        movementsBody.appendChild(tr);
      });
    }

    // AQUI est√° a fun√ß√£o corrigida üëá
    function removeMovement(localId) {
      const mov = movements.find(m => m.localId === localId);
      if (!mov) return;

      if (!confirm("Remover esta baixa e devolver ao estoque?")) return;

      // devolve ao item
      const item = items.find(i => i.id === mov.itemId);
      if (item) {
        item.qty += mov.qty;
      }

      // remove da lista
      movements = movements.filter(m => m.localId !== localId);
      renderMovements();
      renderItems();
      saveAll();

      // manda item atualizado
      if (item) {
        sendToSheet({
          tipo: "salvar_item",
          data: new Date().toLocaleString("pt-BR"),
          placa: "",
          numero: item.id,
          quantidade: item.qty,
          marca: item.marca || "",
          modelo: item.modelo || ""
        });
      }

      // manda info de que extornou
      sendToSheet({
        tipo: "extornar_saida",
        id: mov.itemId,
        nome: mov.itemName,
        qtd: mov.qty,
        preco: mov.price,
        placa: mov.plate,
        observacao: "remo√ß√£o de baixa",
        marca: mov.marca,
        modelo: mov.modelo,
        tamanho: mov.tamanho,
        status: "removido"
      });
    }

    /* ====== 6) DESCARTE / RECAPAGEM (s√≥ mostrar o que tem) ====== */
    const descTableBody = document.getElementById("descTableBody");
    function renderDescartes() {
      descTableBody.innerHTML = "";
      descartes.forEach(d => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${d.date}</td>
          <td>${d.fogo}</td>
          <td>${d.marca||"-"}</td>
          <td>${d.modelo||"-"}</td>
          <td>${d.tamanho||"-"}</td>
          <td>${d.motivo||"-"}</td>
          <td>${d.obs||"-"}</td>
        `;
        descTableBody.appendChild(tr);
      });
    }
    const recapTableBody = document.getElementById("recapTableBody");
    function renderRecapagens() {
      recapTableBody.innerHTML = "";
      recapagens.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.date}</td>
          <td>${r.fogo}</td>
          <td>${r.marca||"-"}</td>
          <td>${r.modelo||"-"}</td>
          <td>${r.tamanho||"-"}</td>
          <td>${r.borracha||"-"}</td>
          <td>${r.recapadora||"-"}</td>
          <td>${r.qty}</td>
          <td>${r.status||"pendente"}</td>
          <td>${r.obs||"-"}</td>
          <td></td>
        `;
        recapTableBody.appendChild(tr);
      });
    }

    /* ====== 7) TABS ====== */
    document.querySelectorAll(".tab-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const tab = btn.dataset.tab;
        document.querySelectorAll("main > div[id^='tab-']").forEach(div => div.classList.add("hidden"));
        document.getElementById("tab-"+tab).classList.remove("hidden");
      });
    });

    /* ====== 8) ENVIAR PRO SHEETS ====== */
    function sendToSheet(payload) {
      if (!SHEETS_ENDPOINT) return;
      const url = SHEETS_ENDPOINT + "?data=" + encodeURIComponent(JSON.stringify(payload));
      // n√£o vamos travar o site se falhar
      fetch(url,{method:"GET"}).catch(()=>{});
    }

    /* ====== 9) BUSCAR DA PLANILHA (MOSTRAR EMBAIXO) ====== */
    async function fetchSheetData() {
      const status = document.getElementById("sheetStatus");
      const body = document.getElementById("sheetBody");
      try {
        const resp = await fetch(SHEETS_ENDPOINT);
        const data = await resp.json(); // se vier [], beleza
        status.textContent = "Carregado " + data.length + " linha(s).";
        body.innerHTML = "";
        if (!data.length) {
          body.innerHTML = `<tr><td colspan="6">Sem registros ainda.</td></tr>`;
          return;
        }
        data.forEach(row => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.data||""}</td>
            <td>${row.placa||""}</td>
            <td>${row.numero||""}</td>
            <td>${row.quantidade||""}</td>
            <td>${row.marca||""}</td>
            <td>${row.modelo||""}</td>
          `;
          body.appendChild(tr);
        });
      } catch (e) {
        status.textContent = "Erro ao conectar na planilha.";
        body.innerHTML = `<tr><td colspan="6">N√£o foi poss√≠vel carregar.</td></tr>`;
      }
    }

    // inicializa tudo
    renderMovements();
    renderDescartes();
    renderRecapagens();
    fetchSheetData();
  </script>
</body>
</html>
