<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Transportes Canarinho - Estoque de Pneus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --panel-light: #1f2937;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.1);
      --text: #e2e8f0;
      --muted: #94a3b8;
      --danger: #f43f5e;
      --radius: 14px;
    }
    * {
      box-sizing: border-box;
      font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
    }
    body {
      margin: 0;
      background: radial-gradient(circle at top, rgba(31, 41, 55, 0.95), #020617);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      font-size: 15px;
      position: relative;
      overflow-x: hidden;
    }
    /* fundo com logo redondo */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background:
        radial-gradient(circle at center, rgba(2, 6, 23, 0) 0%, rgba(2, 6, 23, 0.65) 60%, #020617 100%),
        url("logo-canarinhos2.png") no-repeat center center;
      background-size: 900px auto;
      opacity: 0.12;
      pointer-events: none;
      z-index: -1;
    }
    header {
      padding: 16px 24px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.12);
      display: flex;
      align-items: center;
      gap: 16px;
      background: rgba(2, 6, 23, 0.78);
      backdrop-filter: blur(16px);
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo-icon {
      height: 40px;
      width: 40px;
      border-radius: 10px;
      object-fit: contain;
      background: transparent;
    }
    header h1 {
      font-size: 1.1rem;
      margin: 0;
    }
    .small {
      font-size: 0.7rem;
      color: var(--muted);
    }
    .header-center {
      margin-left: auto;
      font-size: .8rem;
      text-transform: uppercase;
      letter-spacing: .06em;
      background: rgba(15,23,42,.4);
      padding: 4px 14px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.15);
    }
    .tag {
      background: rgba(56, 189, 248, 0.12);
      border: 1px solid rgba(56, 189, 248, 0.4);
      padding: 3px 12px;
      border-radius: 999px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-left: 12px;
    }
    main {
      padding: 20px 24px 40px;
      max-width: 1250px;
      width: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .tabs {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .tab-btn {
      background: rgba(15, 23, 42, 0.2);
      border: 1px solid transparent;
      color: var(--muted);
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 0.72rem;
      cursor: pointer;
    }
    .tab-btn.active {
      background: rgba(56, 189, 248, 0.12);
      border-color: rgba(56, 189, 248, 0.3);
      color: var(--text);
    }
    .toolbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    .input, select {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 999px;
      padding: 8px 14px 8px 32px;
      color: var(--text);
      font-size: 0.85rem;
      outline: none;
    }
    .input-wrapper { position: relative; }
    .input-icon {
      position: absolute;
      left: 10px;
      top: 7px;
      font-size: 0.85rem;
      color: var(--muted);
    }
    .btn {
      background: linear-gradient(120deg, #38bdf8, #0ea5e9);
      color: #020617;
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-weight: 600;
      font-size: 0.78rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-xs {
      background: rgba(15, 23, 42, 0.4);
      border: 1px solid rgba(148, 163, 184, 0.12);
      color: var(--text);
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.7rem;
      cursor: pointer;
    }
    .btn-danger {
      background: rgba(244, 63, 94, 0.1);
      border: 1px solid rgba(244, 63, 94, 0.3);
      color: #ffe4e6;
    }
    .card {
      background: rgba(2, 6, 23, 0.55);
      border: 1px solid rgba(148, 163, 184, 0.06);
      border-radius: var(--radius);
      overflow: hidden;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }
    thead { background: rgba(15, 23, 42, 0.42); }
    th, td {
      text-align: left;
      padding: 10px 14px;
      font-size: 0.8rem;
    }
    th {
      color: var(--muted);
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }
    tbody tr {
      border-bottom: 1px solid rgba(148, 163, 184, 0.06);
      transition: background 0.1s ease-out;
    }
    tbody tr:hover { background: rgba(15, 23, 42, 0.3); }
    .list-wrapper { overflow-x: auto; }
    .hidden { display: none; }
    .inline-form {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 12px 14px 0;
    }
    .inline-form .field {
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-width: 140px;
      flex: 1;
    }
    .inline-form label {
      font-size: .68rem;
      color: var(--muted);
    }
    @media (max-width: 720px) {
      header { flex-direction: column; align-items: flex-start; }
      .header-center { margin-top: 6px; }
      .toolbar { flex-direction: column; align-items: stretch; }
      .input, select { width: 100%; }
      body::before { background-size: 620px auto; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <!-- logo quadrada -->
      <img src="logo-canarinhos.png" alt="Transportes Canarinho" class="logo-icon" />
      <div>
        <h1>Transportes Canarinho</h1>
        <div class="small">Buscando entregar o melhor com qualidade.</div>
      </div>
    </div>
    <div class="header-center">ESTOQUE DE PNEUS</div>
    <span class="tag" id="saveStatus">autosave ativo</span>
  </header>

  <main>
    <div class="tabs">
      <button class="tab-btn active" data-tab="estoque">Estoque</button>
      <button class="tab-btn" data-tab="saidas">Sa√≠das</button>
      <button class="tab-btn" data-tab="recapagem">Recapagem</button>
      <button class="tab-btn" data-tab="descarte">Descarte</button>
    </div>

    <!-- ESTOQUE -->
    <div id="tab-estoque">
      <div class="toolbar">
        <div class="input-wrapper">
          <span class="input-icon">üîç</span>
          <input id="searchInput" class="input" type="text" placeholder="Buscar por FOGO ou nome..." />
        </div>
        <div class="input-wrapper">
          <span class="input-icon">üóÇ</span>
          <select id="categoryFilter" class="input" style="padding-left:30px;">
            <option value="">Todas as categorias</option>
          </select>
        </div>
        <button id="addItemBtn" class="btn">+ Novo pneu</button>
      </div>

      <div class="card" style="margin-top:10px;">
        <div class="list-wrapper">
          <table>
            <thead>
              <tr>
                <th data-sort="id">FOGO</th>
                <th data-sort="name">Nome</th>
                <th>Foto</th>
                <th data-sort="category">Categoria</th>
                <th data-sort="marca">Marca</th>
                <th data-sort="modelo">Modelo</th>
                <th data-sort="tamanho">Tamanho</th>
                <th data-sort="qty">Qtd.</th>
                <th data-sort="reorderPoint">Reposi√ß√£o</th>
                <th style="width: 210px;">A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- SA√çDAS -->
    <div id="tab-saidas" class="hidden">
      <div class="card">
        <div class="list-wrapper">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>FOGO / Nome</th>
                <th>Qtd.</th>
                <th>Placa</th>
                <th>Marca</th>
                <th>Modelo</th>
                <th>Tamanho</th>
                <th>Pre√ßo</th>
                <th>Obs</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="movementsBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- RECAPAGEM -->
    <div id="tab-recapagem" class="hidden">
      <div class="card">
        <div class="inline-form">
          <div class="field">
            <label for="recapFogo">FOGO</label>
            <select id="recapFogo"></select>
          </div>
          <div class="field">
            <label for="recapQtd">Qtd.</label>
            <input type="number" id="recapQtd" min="1" value="1" />
          </div>
          <div class="field">
            <label for="recapMarca">Marca</label>
            <select id="recapMarca"></select>
          </div>
          <div class="field">
            <label for="recapModelo">Modelo</label>
            <select id="recapModelo"></select>
          </div>
          <div class="field">
            <label for="recapTamanho">Tamanho</label>
            <input type="text" id="recapTamanho" placeholder="295/80" />
          </div>
          <div class="field">
            <label for="recapBorracha">Tipo de borracha</label>
            <input type="text" id="recapBorracha" placeholder="ex: Premium" />
          </div>
          <div class="field">
            <label for="recapRecapadora">Recapadora</label>
            <input type="text" id="recapRecapadora" placeholder="Nome da recapadora" />
          </div>
          <div class="field" style="align-self:flex-end;min-width:120px;">
            <button id="recapSubmit" class="btn">‚ñ∂ Enviar</button>
          </div>
        </div>
        <div class="list-wrapper">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>FOGO</th>
                <th>Marca</th>
                <th>Modelo</th>
                <th>Tam.</th>
                <th>Borracha</th>
                <th>Recapadora</th>
                <th>Qtd.</th>
                <th>Status</th>
                <th>Obs</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="recapTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- DESCARTE -->
    <div id="tab-descarte" class="hidden">
      <div class="card">
        <div class="inline-form">
          <div class="field">
            <label for="descFogo">FOGO</label>
            <select id="descFogo"></select>
          </div>
          <div class="field">
            <label for="descQtd">Qtd.</label>
            <input type="number" id="descQtd" value="1" min="1" />
          </div>
          <div class="field">
            <label for="descMarca">Marca</label>
            <select id="descMarca"></select>
          </div>
          <div class="field">
            <label for="descModelo">Modelo</label>
            <select id="descModelo"></select>
          </div>
          <div class="field">
            <label for="descTamanho">Tamanho</label>
            <input type="text" id="descTamanho" placeholder="295/80" />
          </div>
          <div class="field">
            <label for="descMotivo">Motivo</label>
            <input type="text" id="descMotivo" placeholder="Ex: carca√ßa danificada" />
          </div>
          <div class="field" style="align-self:flex-end;min-width:120px;">
            <button id="descSubmit" class="btn">üóë Descartar</button>
          </div>
        </div>
        <div class="list-wrapper">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>FOGO</th>
                <th>Marca</th>
                <th>Modelo</th>
                <th>Tamanho</th>
                <th>Motivo</th>
                <th>Obs</th>
              </tr>
            </thead>
            <tbody id="descTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- BLOCO GOOGLE SHEETS -->
    <div class="card" id="sheetBlock">
      <div style="padding:10px 14px 0;">
        <strong>Registros do Google Sheets</strong>
        <div class="small" id="sheetStatus">Carregando dados...</div>
      </div>
      <div class="list-wrapper">
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Placa</th>
              <th>N¬∫ do pneu</th>
              <th>Quantidade</th>
              <th>Marca</th>
              <th>Modelo</th>
            </tr>
          </thead>
          <tbody id="sheetTableBody">
            <tr><td colspan="6">Carregando...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </main>

  <!-- MODAIS (iguais ao que j√° t√≠nhamos) -->
  <div class="modal-backdrop hidden" id="adjustModal">
    <div class="modal">
      <h2>Ajustar estoque</h2>
      <div class="small" id="adjustItemLabel"></div>
      <label for="adjustType">Tipo de ajuste</label>
      <select id="adjustType">
        <option value="in">Entrada (+)</option>
        <option value="out">Sa√≠da (-)</option>
      </select>
      <label for="adjustAmount">Quantidade</label>
      <input id="adjustAmount" type="number" min="1" value="1" />
      <div id="extraOutBlock" style="display:none;">
        <label for="adjustPlate">Placa</label>
        <input id="adjustPlate" type="text" />
        <label for="adjustMarca">Marca</label>
        <select id="adjustMarca"></select>
        <label for="adjustModelo">Modelo</label>
        <select id="adjustModelo"></select>
        <label for="adjustTamanho">Tamanho</label>
        <input id="adjustTamanho" type="text" />
        <label for="adjustObs">Observa√ß√£o</label>
        <input id="adjustObs" type="text" />
        <label for="adjustPrice">Pre√ßo</label>
        <input id="adjustPrice" type="number" min="0" step="0.01" />
      </div>
      <div class="modal-actions">
        <button class="btn-xs" onclick="closeAdjustModal()">Cancelar</button>
        <button class="btn" onclick="confirmAdjust()">Confirmar</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop hidden" id="editModal">
    <div class="modal">
      <h2 id="editTitle">Novo pneu</h2>
      <label for="editId">FOGO</label>
      <input id="editId" type="text" />
      <label for="editName">Nome</label>
      <input id="editName" type="text" />
      <label for="editCategory">Categoria</label>
      <input id="editCategory" type="text" value="Pneu" />
      <label for="editMarca">Marca</label>
      <select id="editMarca"></select>
      <label for="editModelo">Modelo</label>
      <select id="editModelo"></select>
      <label for="editTamanho">Tamanho</label>
      <input id="editTamanho" type="text" value="295/80" />
      <label for="editQty">Quantidade</label>
      <input id="editQty" type="number" min="0" />
      <label for="editReorder">Ponto de reposi√ß√£o</label>
      <input id="editReorder" type="number" min="0" />
      <label for="editPhoto">Foto do pneu</label>
      <input id="editPhoto" type="file" accept="image/*" />
      <img id="photoPreview" style="width:120px;height:120px;object-fit:cover;border-radius:12px;border:1px solid rgba(148,163,184,0.2);display:none;" />
      <div class="modal-actions">
        <button class="btn-xs" onclick="closeEditModal()">Cancelar</button>
        <button class="btn" onclick="saveItem()">Salvar</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop hidden" id="photoModal">
    <div class="modal">
      <h2>Foto do pneu</h2>
      <img id="photoModalImg" src="" alt="Foto do pneu" style="max-width:480px;max-height:480px;border-radius:12px;" />
      <div class="modal-actions">
        <button class="btn" onclick="closePhotoModal()">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== 1) COLE AQUI SEU LINK DO APPS SCRIPT ( /exec ) ===== */
    const SHEETS_ENDPOINT = "https://script.google.com/macros/s/AKfycbwVgzTSpsua4U8VqCBCLjsKAekpKqYR9MosYkkGv_0WXtd-RRfJWct5G1jb5g8TI_sf9g/exec";
    /* ========================================================= */

    // se quiser for√ßar sem google pra testar:
    const FORCE_NO_SHEETS = false;

    // dados de marca -> modelos
    const TIRE_DATA = {
      "Michelin": [
        { model: "X Multi Z", size: "295/80" },
        { model: "X Multi D", size: "295/80" },
        { model: "X Multi T", size: "295/80" }
      ],
      "Pirelli": [
        { model: "FG-01 MISTO", size: "295/80" },
        { model: "FR-85", size: "295/80" }
      ],
      "Goodyear": [
        { model: "Kmax D", size: "295/80" },
        { model: "Kmax S", size: "295/80" }
      ],
      "Speedmax": [],
      "Firestone": [],
      "Kumho": [],
      "Continental": []
    };

    const STORAGE_KEY_ITEMS = "tc_pneus_items_v1";
    const STORAGE_KEY_MOVES = "tc_pneus_moves_v1";
    const STORAGE_KEY_RECAP = "tc_pneus_recap_v1";
    const STORAGE_KEY_DESC = "tc_pneus_desc_v1";

    let items = loadLocal(STORAGE_KEY_ITEMS, [
      { id: "F-001", name: "Pneu 295/80", category: "Pneu", qty: 9, reorderPoint: 3, photo: "", marca: "Michelin", modelo: "X Multi Z", tamanho: "295/80" },
      { id: "F-002", name: "Pneu 295/80", category: "Pneu", qty: 4, reorderPoint: 2, photo: "", marca: "Pirelli", modelo: "FG-01 MISTO", tamanho: "295/80" }
    ]);
    let movements = loadLocal(STORAGE_KEY_MOVES, []);
    let recapagens = loadLocal(STORAGE_KEY_RECAP, []);
    let descartes = loadLocal(STORAGE_KEY_DESC, []);

    let filtered = [...items];
    let currentSort = { key: "name", dir: "asc" };
    let adjustTarget = null;
    let editTarget = null;
    let tempPhotoData = null;

    const tableBody = document.getElementById("tableBody");
    const itemsCount = null; // n√£o estamos mostrando esse agora
    const searchInput = document.getElementById("searchInput");
    const categoryFilter = document.getElementById("categoryFilter");
    const saveStatus = document.getElementById("saveStatus");
    const movementsBody = document.getElementById("movementsBody");
    const recapTableBody = document.getElementById("recapTableBody");
    const descTableBody = document.getElementById("descTableBody");
    const sheetStatus = document.getElementById("sheetStatus");
    const sheetTableBody = document.getElementById("sheetTableBody");

    function loadLocal(key, fallback) {
      const raw = localStorage.getItem(key);
      if (raw) {
        try { return JSON.parse(raw); } catch(e) {}
      }
      return fallback;
    }
    function saveAll() {
      localStorage.setItem(STORAGE_KEY_ITEMS, JSON.stringify(items));
      localStorage.setItem(STORAGE_KEY_MOVES, JSON.stringify(movements));
      localStorage.setItem(STORAGE_KEY_RECAP, JSON.stringify(recapagens));
      localStorage.setItem(STORAGE_KEY_DESC, JSON.stringify(descartes));
      if (saveStatus) {
        saveStatus.textContent = "salvo ‚úî";
        setTimeout(() => saveStatus.textContent = "autosave ativo", 1500);
      }
      fillFogoSelects();
    }

    function sendToSheet(payload) {
      if (!SHEETS_ENDPOINT || FORCE_NO_SHEETS) return;
      const url = SHEETS_ENDPOINT + "?data=" + encodeURIComponent(JSON.stringify(payload));
      fetch(url, { mode: "no-cors" }).catch(() => {});
    }

    function applyFilters() {
      const term = (searchInput?.value || "").toLowerCase();
      const cat = categoryFilter.value;
      filtered = items.filter(i => {
        const matchText = i.name.toLowerCase().includes(term) || i.id.toLowerCase().includes(term);
        const matchCat = cat ? i.category === cat : true;
        return matchText && matchCat;
      });
      applySort();
    }
    function applySort() {
      const { key, dir } = currentSort;
      filtered.sort((a, b) => {
        if ((a[key] || "") < (b[key] || "")) return dir === "asc" ? -1 : 1;
        if ((a[key] || "") > (b[key] || "")) return dir === "asc" ? 1 : -1;
        return 0;
      });
      renderTable();
    }
    function renderTable() {
      tableBody.innerHTML = "";
      filtered.forEach(item => {
        const needsReorder = item.qty <= item.reorderPoint;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.id}</td>
          <td>${item.name}</td>
          <td>${item.photo ? `<img src="${item.photo}" style="width:52px;height:52px;border-radius:10px;object-fit:cover;border:1px solid rgba(148,163,184,0.2);" onclick="openPhotoModal('${item.id}')" />` : `<span class="small" style="color:var(--muted);">sem foto</span>`}</td>
          <td><span class="badge">${item.category || "-"}</span></td>
          <td>${item.marca || "-"}</td>
          <td>${item.modelo || "-"}</td>
          <td>${item.tamanho || "-"}</td>
          <td><span class="badge ${needsReorder ? "qty-low" : ""}">${item.qty}</span></td>
          <td>${item.reorderPoint}</td>
          <td>
            <div class="actions" style="display:flex;gap:6px;">
              <button class="btn-xs" onclick="openAdjustModal('${item.id}')">Ajustar</button>
              <button class="btn-xs" onclick="openEditModal('${item.id}')">Editar</button>
              <button class="btn-xs btn-danger" onclick="deleteItem('${item.id}')">Excluir</button>
            </div>
          </td>
        `;
        tableBody.appendChild(tr);
      });
      renderCategoryFilter();
    }
    function renderCategoryFilter() {
      const cats = Array.from(new Set(items.map(i => i.category))).sort();
      const currentValue = categoryFilter.value;
      categoryFilter.innerHTML = '<option value="">Todas as categorias</option>';
      cats.forEach(c => {
        if (!c) return;
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        categoryFilter.appendChild(opt);
      });
      if (currentValue) categoryFilter.value = currentValue;
    }

    if (searchInput) searchInput.addEventListener("input", applyFilters);
    if (categoryFilter) categoryFilter.addEventListener("change", applyFilters);

    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        const tab = btn.dataset.tab;
        document.querySelectorAll("main > div[id^='tab-']").forEach(div => div.classList.add("hidden"));
        document.getElementById("tab-" + tab).classList.remove("hidden");
      });
    });

    function openAdjustModal(id) {
      adjustTarget = items.find(i => i.id === id);
      document.getElementById("adjustItemLabel").textContent = adjustTarget.id + " ‚Äì " + adjustTarget.name;
      document.getElementById("adjustAmount").value = 1;
      document.getElementById("adjustType").value = "in";
      document.getElementById("extraOutBlock").style.display = "none";
      document.getElementById("adjustTamanho").value = adjustTarget.tamanho || "295/80";
      fillMarcaSelect("adjustMarca");
      fillModelSelect("adjustMarca", "adjustModelo");
      document.getElementById("adjustModal").classList.remove("hidden");
      document.getElementById("adjustModal").style.display = "flex";
    }
    function closeAdjustModal() {
      document.getElementById("adjustModal").style.display = "none";
      document.getElementById("adjustModal").classList.add("hidden");
      adjustTarget = null;
    }
    document.getElementById("adjustType").addEventListener("change", e => {
      document.getElementById("extraOutBlock").style.display = e.target.value === "out" ? "block" : "none";
    });

    function confirmAdjust() {
      const amount = parseInt(document.getElementById("adjustAmount").value, 10) || 0;
      const type   = document.getElementById("adjustType").value;
      const plate  = document.getElementById("adjustPlate").value.trim().toUpperCase();
      const marca  = document.getElementById("adjustMarca").value;
      const modelo = document.getElementById("adjustModelo").value;
      const tamanho= document.getElementById("adjustTamanho").value || "295/80";
      const obs    = document.getElementById("adjustObs").value.trim();
      const price  = parseFloat(document.getElementById("adjustPrice").value || "0");

      if (!adjustTarget || amount <= 0) { closeAdjustModal(); return; }

      const now = new Date();
      const dateStr = now.toLocaleDateString("pt-BR") + " " + now.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});

      if (type === "in") {
        adjustTarget.qty += amount;
        sendToSheet({
          tipo: "entrada",
          data: dateStr,
          placa: "",
          numero: adjustTarget.id,
          quantidade: amount,
          marca: marca,
          modelo: modelo
        });
      } else {
        adjustTarget.qty = Math.max(0, adjustTarget.qty - amount);
        const mov = {
          localId: "mov_"+Date.now(),
          date: dateStr,
          itemId: adjustTarget.id,
          itemName: adjustTarget.name,
          qty: amount,
          plate: plate,
          marca: marca,
          modelo: modelo,
          tamanho: tamanho,
          price: isNaN(price)?0:price,
          obs: obs
        };
        movements.unshift(mov);
        renderMovements();
        sendToSheet({
          tipo: "saida",
          data: dateStr,
          placa: plate,
          numero: adjustTarget.id,
          quantidade: amount,
          marca: marca,
          modelo: modelo
        });
      }
      closeAdjustModal();
      applyFilters();
      saveAll();
    }

    const addItemBtn = document.getElementById("addItemBtn");
    if (addItemBtn) addItemBtn.addEventListener("click", () => openEditModal(null));

    function openEditModal(id) {
      fillMarcaSelect("editMarca");
      fillModelSelect("editMarca", "editModelo");
      const photoPreview = document.getElementById("photoPreview");
      tempPhotoData = null;
      if (id) {
        editTarget = items.find(i => i.id === id);
        document.getElementById("editTitle").textContent = "Editar pneu";
        document.getElementById("editId").value = editTarget.id;
        document.getElementById("editName").value = editTarget.name;
        document.getElementById("editCategory").value = editTarget.category;
        document.getElementById("editMarca").value = editTarget.marca || "";
        fillModelSelect("editMarca", "editModelo", editTarget.modelo);
        document.getElementById("editTamanho").value = editTarget.tamanho || "295/80";
        document.getElementById("editQty").value = editTarget.qty;
        document.getElementById("editReorder").value = editTarget.reorderPoint;
        if (editTarget.photo) {
          photoPreview.src = editTarget.photo;
          photoPreview.style.display = "block";
        } else {
          photoPreview.style.display = "none";
        }
      } else {
        editTarget = null;
        document.getElementById("editTitle").textContent = "Novo pneu";
        document.getElementById("editId").value = "";
        document.getElementById("editName").value = "";
        document.getElementById("editCategory").value = "Pneu";
        document.getElementById("editMarca").value = "Michelin";
        fillModelSelect("editMarca", "editModelo");
        document.getElementById("editTamanho").value = "295/80";
        document.getElementById("editQty").value = 0;
        document.getElementById("editReorder").value = 0;
        photoPreview.style.display = "none";
      }
      document.getElementById("editPhoto").value = "";
      document.getElementById("editModal").classList.remove("hidden");
      document.getElementById("editModal").style.display = "flex";
    }
    document.getElementById("editPhoto").addEventListener("change", function(e){
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        tempPhotoData = ev.target.result;
        const photoPreview = document.getElementById("photoPreview");
        photoPreview.src = tempPhotoData;
        photoPreview.style.display = "block";
      };
      reader.readAsDataURL(file);
    });
    function closeEditModal(){
      document.getElementById("editModal").style.display = "none";
      document.getElementById("editModal").classList.add("hidden");
      editTarget = null;
      tempPhotoData = null;
    }
    function saveItem() {
      const id = document.getElementById("editId").value.trim();
      const name = document.getElementById("editName").value.trim() || "Pneu";
      const category = document.getElementById("editCategory").value.trim() || "Pneu";
      const marca = document.getElementById("editMarca").value;
      const modelo = document.getElementById("editModelo").value;
      const tamanho = document.getElementById("editTamanho").value || "295/80";
      const qty = parseInt(document.getElementById("editQty").value, 10) || 0;
      const reorderPoint = parseInt(document.getElementById("editReorder").value, 10) || 0;
      if (!id) {
        alert("FOGO √© obrigat√≥rio.");
        return;
      }
      if (editTarget) {
        editTarget.id = id;
        editTarget.name = name;
        editTarget.category = category;
        editTarget.marca = marca;
        editTarget.modelo = modelo;
        editTarget.tamanho = tamanho;
        editTarget.qty = qty;
        editTarget.reorderPoint = reorderPoint;
        if (tempPhotoData) editTarget.photo = tempPhotoData;
      } else {
        items.push({ id, name, category, qty, reorderPoint, photo: tempPhotoData || "", marca, modelo, tamanho });
      }
      closeEditModal();
      applyFilters();
      saveAll();
    }
    function deleteItem(id) {
      if (!confirm("Tem certeza que deseja excluir este pneu?")) return;
      items = items.filter(i => i.id !== id);
      applyFilters();
      saveAll();
    }

    function openPhotoModal(itemId) {
      const item = items.find(i => i.id === itemId);
      if (!item || !item.photo) return;
      document.getElementById("photoModalImg").src = item.photo;
      document.getElementById("photoModal").style.display = "flex";
      document.getElementById("photoModal").classList.remove("hidden");
    }
    function closePhotoModal() {
      document.getElementById("photoModal").style.display = "none";
      document.getElementById("photoModal").classList.add("hidden");
    }

    function renderMovements(){
      movementsBody.innerHTML = "";
      movements.forEach(m => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${m.date}</td>
          <td>${m.itemId} ‚Äì ${m.itemName || ""}</td>
          <td>${m.qty}</td>
          <td>${m.plate || "-"}</td>
          <td>${m.marca || "-"}</td>
          <td>${m.modelo || "-"}</td>
          <td>${m.tamanho || "-"}</td>
          <td>${m.price ? "R$ " + m.price.toFixed(2) : "-"}</td>
          <td>${m.obs || "-"}</td>
          <td><button class="btn-xs btn-danger" onclick="removeMovement('${m.localId}')">Remover</button></td>
        `;
        movementsBody.appendChild(tr);
      });
    }
    function removeMovement(localId) {
      const mov = movements.find(m => m.localId === localId);
      if (!mov) return;
      if (!confirm("Remover esta baixa e devolver ao estoque?")) return;

      const item = items.find(i => i.id === mov.itemId);
      if (item) {
        item.qty += mov.qty;
      }

      movements = movements.filter(m => m.localId !== localId);
      renderMovements();
      applyFilters();
      saveAll();

      sendToSheet({
        tipo: "extornar_saida",
        data: mov.date,
        placa: mov.plate,
        numero: mov.itemId,
        quantidade: mov.qty,
        marca: mov.marca,
        modelo: mov.modelo
      });
    }

    document.getElementById("recapSubmit").addEventListener("click", () => {
      const fogo = document.getElementById("recapFogo").value;
      const qtd  = parseInt(document.getElementById("recapQtd").value, 10)||0;
      const marca= document.getElementById("recapMarca").value;
      const modelo=document.getElementById("recapModelo").value;
      const tamanho=document.getElementById("recapTamanho").value||"295/80";
      const borracha=document.getElementById("recapBorracha").value;
      const recapadora=document.getElementById("recapRecapadora").value;
      const obs=document.getElementById("recapObs").value;
      if (!fogo || qtd<=0) { alert("Selecione o FOGO e quantidade."); return; }
      const item = items.find(i => i.id === fogo);
      if (!item) { alert("FOGO n√£o encontrado."); return; }
      item.qty = Math.max(0, item.qty - qtd);
      const now = new Date();
      const dateStr = now.toLocaleDateString("pt-BR")+" "+now.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});
      const rec = {
        recId: "rec_"+Date.now(),
        date: dateStr,
        fogo,
        marca,
        modelo,
        tamanho,
        borracha,
        recapadora,
        obs,
        qty: qtd,
        status:"pendente"
      };
      recapagens.unshift(rec);
      renderRecapagens();
      applyFilters();
      saveAll();

      sendToSheet({
        tipo: "recapagem",
        data: dateStr,
        placa: "",
        numero: fogo,
        quantidade: qtd,
        marca: marca,
        modelo: modelo
      });
    });
    function renderRecapagens(){
      recapTableBody.innerHTML = "";
      recapagens.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.date}</td>
          <td>${r.fogo}</td>
          <td>${r.marca || "-"}</td>
          <td>${r.modelo || "-"}</td>
          <td>${r.tamanho || "-"}</td>
          <td>${r.borracha || "-"}</td>
          <td>${r.recapadora || "-"}</td>
          <td>${r.qty}</td>
          <td>${r.status}</td>
          <td>${r.obs || "-"}</td>
          <td>${r.status==="pendente" ? `<button class="btn-xs" onclick="returnRecap('${r.recId}')">Voltar</button>` : ""}</td>
        `;
        recapTableBody.appendChild(tr);
      });
    }
    function returnRecap(recId){
      const rec = recapagens.find(r => r.recId === recId);
      if (!rec) return;
      const item = items.find(i => i.id === rec.fogo);
      if (item) item.qty += rec.qty;
      rec.status = "retornado";
      renderRecapagens();
      applyFilters();
      saveAll();
      sendToSheet({
        tipo: "retorno_recapagem",
        data: rec.date,
        placa: "",
        numero: rec.fogo,
        quantidade: rec.qty,
        marca: rec.marca,
        modelo: rec.modelo
      });
    }

    document.getElementById("descSubmit").addEventListener("click", () => {
      const fogo = document.getElementById("descFogo").value;
      const qtd = parseInt(document.getElementById("descQtd").value,10)||0;
      const marca = document.getElementById("descMarca").value;
      const modelo = document.getElementById("descModelo").value;
      const tamanho = document.getElementById("descTamanho").value||"295/80";
      const motivo = document.getElementById("descMotivo").value;
      const obs = document.getElementById("descObs").value;
      if (!fogo || qtd<=0){ alert("Selecione o FOGO e quantidade."); return; }
      const item = items.find(i => i.id === fogo);
      if (!item){ alert("FOGO n√£o encontrado."); return; }
      item.qty = Math.max(0, item.qty - qtd);
      const now = new Date();
      const dateStr = now.toLocaleDateString("pt-BR")+" "+now.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});
      const desc = {
        descId: "desc_"+Date.now(),
        date: dateStr,
        fogo,
        marca,
        modelo,
        tamanho,
        motivo,
        obs,
        qty: qtd
      };
      descartes.unshift(desc);
      renderDescartes();
      applyFilters();
      saveAll();

      sendToSheet({
        tipo: "descarte",
        data: dateStr,
        placa: "",
        numero: fogo,
        quantidade: qtd,
        marca: marca,
        modelo: modelo
      });
    });
    function renderDescartes(){
      descTableBody.innerHTML = "";
      descartes.forEach(d => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${d.date}</td>
          <td>${d.fogo}</td>
          <td>${d.marca || "-"}</td>
          <td>${d.modelo || "-"}</td>
          <td>${d.tamanho || "-"}</td>
          <td>${d.motivo || "-"}</td>
          <td>${d.obs || "-"}</td>
        `;
        descTableBody.appendChild(tr);
      });
    }

    function fillMarcaSelect(id){
      const sel = document.getElementById(id);
      if (!sel) return;
      sel.innerHTML = "";
      Object.keys(TIRE_DATA).forEach(m => {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        sel.appendChild(opt);
      });
    }
    function fillModelSelect(marcaSelectId, modelSelectId, preselect=null){
      const ms = document.getElementById(marcaSelectId);
      const mod = document.getElementById(modelSelectId);
      if (!ms || !mod) return;
      const marca = ms.value;
      const list = TIRE_DATA[marca] || [];
      mod.innerHTML = "";
      if (list.length === 0){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "‚Äî";
        mod.appendChild(opt);
      } else {
        list.forEach(obj => {
          const opt = document.createElement("option");
          opt.value = obj.model;
          opt.textContent = obj.model;
          mod.appendChild(opt);
        });
      }
      if (preselect) mod.value = preselect;
    }
    document.addEventListener("change", e => {
      if (e.target.id === "editMarca") fillModelSelect("editMarca", "editModelo");
      if (e.target.id === "adjustMarca") fillModelSelect("adjustMarca", "adjustModelo");
      if (e.target.id === "recapMarca") fillModelSelect("recapMarca", "recapModelo");
      if (e.target.id === "descMarca") fillModelSelect("descMarca", "descModelo");
    });

    function fillFogoSelects(){
      const recapFogo = document.getElementById("recapFogo");
      const descFogo = document.getElementById("descFogo");
      [recapFogo, descFogo].forEach(sel => {
        if (!sel) return;
        sel.innerHTML = "";
        items.forEach(it => {
          const opt = document.createElement("option");
          opt.value = it.id;
          opt.textContent = it.id + " ‚Äì " + it.name;
          sel.appendChild(opt);
        });
      });
    }

    // carrega da planilha (GET)
    function fetchSheetData(){
      if (FORCE_NO_SHEETS || !SHEETS_ENDPOINT) {
        sheetStatus.textContent = "Google Sheets desligado (teste).";
        sheetTableBody.innerHTML = "<tr><td colspan='6'>‚Äì</td></tr>";
        return;
      }
      fetch(SHEETS_ENDPOINT)
        .then(r => r.json())
        .then(data => {
          sheetStatus.textContent = "Dados carregados da planilha.";
          sheetTableBody.innerHTML = "";
          if (!data || !Array.isArray(data) || data.length === 0){
            sheetTableBody.innerHTML = "<tr><td colspan='6'>Sem registros.</td></tr>";
            return;
          }
          data.forEach(row => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${row.data || ""}</td>
              <td>${row.placa || ""}</td>
              <td>${row.numero || ""}</td>
              <td>${row.quantidade || ""}</td>
              <td>${row.marca || ""}</td>
              <td>${row.modelo || ""}</td>
            `;
            sheetTableBody.appendChild(tr);
          });
        })
        .catch(() => {
          sheetStatus.textContent = "Erro ao conectar na planilha.";
          sheetTableBody.innerHTML = "<tr><td colspan='6'>Erro...</td></tr>";
        });
    }

    // inicializa
    applyFilters();
    renderMovements();
    renderRecapagens();
    renderDescartes();
    fillMarcaSelect("recapMarca");
    fillModelSelect("recapMarca", "recapModelo");
    fillMarcaSelect("descMarca");
    fillModelSelect("descMarca", "descModelo");
    fillFogoSelects();

    // √∫ltimo: tenta buscar da planilha
    fetchSheetData();
  </script>
</body>
</html>
